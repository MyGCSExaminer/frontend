<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chat with Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f7f9fc; --panel:#fff; --ink:#0f172a; --muted:#64748b; --ai:#0a7a3f; --you:#1d4ed8; --err:#b91c1c; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--ink); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { max-width: 820px; margin: 24px auto; padding: 0 16px; }
    h1 { margin: 0 0 16px; font-size: 22px; }
    .panel { background:var(--panel); border-radius:14px; box-shadow:0 6px 18px rgba(2,6,23,.06); padding:16px; }
    #log { max-height: 60vh; overflow:auto; padding:4px; }
    .bubble { padding:10px 12px; border-radius:12px; margin:8px 0; background:#eef2ff; color:var(--you); }
    .bubble.ai { background:#ecfdf3; color:var(--ai); }
    .meta { font-size:12px; color:var(--muted); margin-top:4px; }
    .row { display:flex; gap:8px; align-items:stretch; }
    textarea { flex:1; resize:vertical; min-height:64px; padding:10px; border:1px solid #e2e8f0; border-radius:10px; }
    input[type=file] { width:100%; }
    button { background:#111827; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .bar { display:grid; gap:8px; margin-top:10px; }
    @media (min-width:720px){ .bar { grid-template-columns: 1fr 1fr auto; } }
    .preview { margin-top:6px; font-size:13px; color:var(--muted); }
    .preview img { max-width:200px; max-height:200px; border-radius:8px; border:1px solid #e5e7eb; display:block; margin-top:6px; }
    .banner { display:none; padding:10px 12px; border-radius:10px; margin:10px 0; background:#fef2f2; color:var(--err); border:1px solid #fecaca; }
    .typing { font-size:13px; color:var(--muted); margin:8px 0 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Chat with Assistant</h1>

    <div id="err" class="banner"></div>

    <div class="panel">
      <div id="log"></div>

      <div class="bar">
        <textarea id="msg" placeholder="Type your message…"></textarea>
        <div>
          <input id="file" type="file" />
          <div id="preview" class="preview"></div>
        </div>
        <div>
          <button id="send">Send</button>
        </div>
      </div>

      <div id="typing" class="typing" style="display:none;">AI is typing…</div>
    </div>
  </div>

  <script>
    // CHANGE THIS ONLY IF YOUR BACKEND URL CHANGES
    const API = "https://backend-code-80kr.onrender.com/chat";

    const logEl = document.getElementById("log");
    const msgEl = document.getElementById("msg");
    const fileEl = document.getElementById("file");
    const previewEl = document.getElementById("preview");
    const sendBtn = document.getElementById("send");
    const errEl = document.getElementById("err");
    const typingEl = document.getElementById("typing");

    let session = localStorage.getItem("session_id") || null;

    // Helpers
    function showError(msg){
      errEl.textContent = msg;
      errEl.style.display = "block";
      setTimeout(()=>{ errEl.style.display = "none"; }, 4000);
    }
    function addBubble(text, who="you"){
      const p = document.createElement("div");
      p.className = "bubble" + (who === "ai" ? " ai" : "");
      p.innerHTML = `<strong>${who === "ai" ? "AI" : "You"}:</strong> ${escapeHtml(text)}`;
      logEl.appendChild(p);
      logEl.scrollTop = logEl.scrollHeight;
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    async function makePreview(file){
      previewEl.innerHTML = "";
      if (!file) return;
      if (file.type.startsWith("image/")){
        const url = URL.createObjectURL(file);
        const img = document.createElement("img");
        img.src = url;
        previewEl.appendChild(img);
      } else if (file.type.startsWith("text/")){
        const text = await file.text();
        const snip = document.createElement("div");
        snip.textContent = text.slice(0, 400) + (text.length > 400 ? "…" : "");
        previewEl.appendChild(snip);
      } else {
        const meta = document.createElement("div");
        meta.textContent = `Selected: ${file.name} (${file.type || "unknown"})`;
        previewEl.appendChild(meta);
      }
    }

    fileEl.addEventListener("change", () => makePreview(fileEl.files[0]));

    // Send handler
    sendBtn.addEventListener("click", async () => {
      const text = msgEl.value.trim();
      const file = fileEl.files[0];

      if (!text && !file){
        showError("Please enter a message or choose a file.");
        return;
      }

      // UI: show user bubble + lock UI
      addBubble(text || (file ? `[File] ${file.name}` : ""), "you");
      sendBtn.disabled = true;
      typingEl.style.display = "block";
      const oldPreview = previewEl.innerHTML;
      previewEl.innerHTML = "";
      msgEl.value = "";
      fileEl.value = "";

      try {
        const fd = new FormData();
        fd.append("message", text);
        if (session) fd.append("session_id", session);
        if (file) fd.append("file", file);

        const res = await fetch(API, { method: "POST", body: fd });
        const data = await res.json();

        if (!res.ok){
          addBubble(`Error — ${data.detail || "Request failed"}`, "ai");
          return;
        }

        if (data.session_id){
          session = data.session_id;
          localStorage.setItem("session_id", session);
        }
        addBubble(data.response || "[No response text returned]", "ai");

      } catch (e){
        console.error(e);
        addBubble(`Error — ${e.message || e}`, "ai");
      } finally {
        sendBtn.disabled = false;
        typingEl.style.display = "none";
      }
    });
  </script>
</body>
</html>
