<script>
const API = "https://backend-code-80kr.onrender.com/chat";

// Always ensure we have a persistent session_id
let session = localStorage.getItem("session_id");
if (!session) {
  session = self.crypto?.randomUUID?.() || Math.random().toString(36).slice(2);
  localStorage.setItem("session_id", session);
}

document.getElementById("send").onclick = async () => {
  let msg = document.getElementById("msg").value.trim();
  if (!msg) return;
  document.getElementById("chat").innerHTML += `<p class="user"><strong>You:</strong> ${msg}</p>`;
  document.getElementById("msg").value = "";
  try {
    let res = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: msg, session_id: session })
    });
    if (!res.ok) throw new Error((await res.json()).detail || "Unknown error");
    let data = await res.json();
    // Only update session if backend gives a new one (usually not needed, but safe)
    if (data.session_id && data.session_id !== session) {
      session = data.session_id;
      localStorage.setItem("session_id", session);
    }
    document.getElementById("chat").innerHTML += `<p class="ai"><strong>AI:</strong> ${data.response}</p>`;
  } catch (e) {
    alert("Error: " + (e.detail || e.message));
  }
};
</script>
